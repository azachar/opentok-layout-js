/*!
 *  opentok-layout-js (http://github.com/aullman/opentok-layout-js)
 *
 *  Automatic layout of video elements (publisher and subscriber) minimising
 *  white-space for the OpenTok on WebRTC API.
 *
 *  @Author: Adam Ullman (http://github.com/aullman)
 *  @Copyright (c) 2014 Adam Ullman
 *  @License: Released under the MIT license (http://opensource.org/licenses/MIT)
**/
if("undefined"==typeof module||"undefined"==typeof module.exports)exports=window;else var window=null;!function(t){var i=OT.$||OT.getHelper(),e=function(e,o,a,r,n,g){var d={left:o+"px",top:a+"px",width:r+"px",height:n+"px"},l=function(){var t=e.querySelector(".OT_root");if(t){var i=t.style.width;t.style.width=r+"px",t.style.width=i||""}};g&&t?(console.log("animate"),t(e).stop(),t(e).animate(d,g.duration||200,g.easing||"swing",function(){l(),g.complete&&g.complete.call(this)})):i.css(e,d),l()},o=function(t,e){var o=i.css(t,e);return o?parseInt(o,10):0},a=function(){return(1e8*Math.random()).toFixed(0)},r=function(t){var e=i.height(t);return e?parseInt(e,10):0},n=function(t){var e=i.width(t);return e?parseInt(e,10):0},g=function(t,a,r,n,g,d,l,s,h){var f,u=t.length,p=function(t,i){for(var e,o,n,g,d,l,s,h,p=1;u>=p;p++){var c=p,v=Math.ceil(u/c);s=Math.floor(r/v),l=Math.floor(a/c),h=s/l,h>i?(h=i,s=l*h):t>h&&(h=t,l=s/h);var b=l*s*u;(void 0===e||b>e)&&(e=b,g=s,d=l,o=c,n=v)}return{maxArea:e,targetCols:o,targetRows:n,targetHeight:g,targetWidth:d,ratio:f}};if(d){var c=t.length>0&&t[0].querySelector("video");f=c&&c.videoHeight&&c.videoWidth?p(c.videoHeight/c.videoWidth,c.videoHeight/c.videoWidth):p(.75,.75)}else f=p(l,s);for(var v=f.targetRows*f.targetCols-u,b=v*f.targetWidth/2,m=(f.targetRows-1)*f.targetCols,R=(r-f.targetRows*f.targetHeight)/2,x=(a-f.targetCols*f.targetWidth)/2,y=0,w=0,M=0;M<t.length;M++){var H=t[M];M%f.targetCols===0?(y=x,M==m&&(y+=b),w+=0===M?R:f.targetHeight):y+=f.targetWidth,i.css(H,"position","absolute");var T=f.targetWidth-o(H,"paddingLeft")-o(H,"paddingRight")-o(H,"marginLeft")-o(H,"marginRight")-o(H,"borderLeft")-o(H,"borderRight"),W=f.targetHeight-o(H,"paddingTop")-o(H,"paddingBottom")-o(H,"marginTop")-o(H,"marginBottom")-o(H,"borderTop")-o(H,"borderBottom");e(H,y+n,w+g,T,W,h)}},d=function(t){return"none"!==i.css(t,"display")},l=function(t,e,l){if("none"!==i.css(t,"display")){var s=t.getAttribute("id");s||(s="OT_"+a(),t.setAttribute("id",s));var h=r(t)-o(t,"borderTop")-o(t,"borderBottom"),f=n(t)-o(t,"borderLeft")-o(t,"borderRight"),u=h/f,p=0,c=0,v=0,b=0,m=0,R=Array.prototype.filter.call(t.querySelectorAll("#"+s+">."+e.bigClass),d),x=Array.prototype.filter.call(t.querySelectorAll("#"+s+">*:not(."+e.bigClass+")"),d);if(R.length>0&&x.length>0){var y=R[0].querySelector("video");m=y&&y.videoHeight&&y.videoWidth?y.videoHeight/y.videoWidth:.75;var w,M;u>m?(w=f,M=Math.min(Math.floor(h*e.bigPercentage),f*m),c=M,v=h-c):(M=h,w=Math.min(f*e.bigPercentage,Math.floor(M/m)),p=w,b=f-p),e.bigFirst?(g(R,w,M,0,0,e.bigFixedRatio,e.bigMinRatio,e.bigMaxRatio,e.animate),g(x,f-p,h-c,p,c,e.fixedRatio,e.minRatio,e.maxRatio,e.animate)):(g(x,f-p,h-c,0,0,e.fixedRatio,e.minRatio,e.maxRatio,e.animate),g(R,w,M,b,v,e.bigFixedRatio,e.bigMinRatio,e.bigMaxRatio,e.animate))}else R.length>0&&0===x.length?g(R,f,h,0,0,e.bigFixedRatio,e.bigMinRatio,e.bigMaxRatio,e.animate):g(x,f-p,h-c,p,c,e.fixedRatio,e.minRatio,e.maxRatio,e.animate)}};exports.initLayoutContainer=function(t,e){return e=i.defaults(e||{},{maxRatio:1.5,minRatio:9/16,fixedRatio:!1,animate:!1,bigClass:"OT_big",bigPercentage:.8,bigFixedRatio:!1,bigMaxRatio:1.5,bigMinRatio:9/16,bigFirst:!0}),t="string"==typeof t?i(t):t,OT.onLoad(function(){l(t,e)}),{layout:l.bind(null,t,e)}}}(window&&window.hasOwnProperty("jQuery")?jQuery:void 0);