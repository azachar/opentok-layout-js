/*!
 *  opentok-layout-js (http://github.com/aullman/opentok-layout-js)
 *
 *  Automatic layout of video elements (publisher and subscriber) minimising
 *  white-space for the OpenTok on WebRTC API.
 *
 *  @Author: Adam Ullman (http://github.com/aullman)
 *  @Copyright (c) 2014 Adam Ullman
 *  @License: Released under the MIT license (http://opensource.org/licenses/MIT)
**/
("undefined"==typeof module||"undefined"==typeof module.exports)&&(exports=window),function(t){var i=OT.$||OT.getHelper(),e=function(e,o,a,r,n,g){var d={left:o+"px",top:a+"px",width:r+"px",height:n+"px"},l=function(){var t=e.querySelector(".OT_root");if(t){var i=t.style.width;t.style.width=r+"px",t.style.width=i||""}};g&&t?(console.log("animate"),t(e).stop(),t(e).animate(d,g.duration||200,g.easing||"swing",function(){l(),g.complete&&g.complete.call(this)})):i.css(e,d),l()},o=function(t,e){var o=i.css(t,e);return o?parseInt(o,10):0},a=function(){return(1e8*Math.random()).toFixed(0)},r=function(t){var e=i.height(t);return e?parseInt(e,10):0},n=function(t){var e=i.width(t);return e?parseInt(e,10):0},g=function(t,a,r,n,g,d,l,s,h){var R,f=t.length,u=function(t,i){for(var e,o,n,g,d,l,s,h=1;f>=h;h++){var u=h,b=Math.ceil(f/u);s=Math.floor(r/b),l=Math.floor(a/u),tRatio=s/l,tRatio>i?(tRatio=i,s=l*tRatio):tRatio<t&&(tRatio=t,l=s/tRatio);var p=l*s*f;(void 0===e||p>e)&&(e=p,g=s,d=l,o=u,n=b)}return{maxArea:e,targetCols:o,targetRows:n,targetHeight:g,targetWidth:d,ratio:R}};if(d){var b=t.length>0&&t[0].querySelector("video");R=b&&b.videoHeight&&b.videoWidth?u(b.videoHeight/b.videoWidth,b.videoHeight/b.videoWidth):u(.75,.75)}else R=u(l,s);for(var p=R.targetRows*R.targetCols-f,c=p*R.targetWidth/2,m=(R.targetRows-1)*R.targetCols,v=(r-R.targetRows*R.targetHeight)/2,x=(a-R.targetCols*R.targetWidth)/2,y=0,w=0,M=0;M<t.length;M++){var T=t[M];M%R.targetCols===0?(y=x,M==m&&(y+=c),w+=0===M?v:R.targetHeight):y+=R.targetWidth,i.css(T,"position","absolute");var C=R.targetWidth-o(T,"paddingLeft")-o(T,"paddingRight")-o(T,"marginLeft")-o(T,"marginRight")-o(T,"borderLeft")-o(T,"borderRight"),H=R.targetHeight-o(T,"paddingTop")-o(T,"paddingBottom")-o(T,"marginTop")-o(T,"marginBottom")-o(T,"borderTop")-o(T,"borderBottom");e(T,y+n,w+g,C,H,h)}},d=function(t){return"none"!==i.css(t,"display")},l=function(t,e,l){if("none"!==i.css(t,"display")){var s=t.getAttribute("id");s||(s="OT_"+a(),t.setAttribute("id",s));var h=r(t)-o(t,"borderTop")-o(t,"borderBottom"),R=n(t)-o(t,"borderLeft")-o(t,"borderRight"),f=h/R,u=0,b=0,p=0,c=0,m=Array.prototype.filter.call(t.querySelectorAll("#"+s+">."+e.bigClass),d),v=Array.prototype.filter.call(t.querySelectorAll("#"+s+">*:not(."+e.bigClass+")"),d);if(m.length>0&&v.length>0){var x=m[0].querySelector("video");x&&x.videoHeight&&x.videoWidth?bigRatio=x.videoHeight/x.videoWidth:bigRatio=.75;var y,w;f>bigRatio?(y=R,w=Math.min(Math.floor(h*e.bigPercentage),R*bigRatio),b=w,p=h-b):(w=h,y=Math.min(R*e.bigPercentage,Math.floor(w/bigRatio)),u=y,c=R-u),e.bigFirst?(g(m,y,w,0,0,e.bigFixedRatio,e.bigMinRatio,e.bigMaxRatio,e.animate),g(v,R-u,h-b,u,b,e.fixedRatio,e.minRatio,e.maxRatio,e.animate)):(g(v,R-u,h-b,0,0,e.fixedRatio,e.minRatio,e.maxRatio,e.animate),g(m,y,w,c,p,e.bigFixedRatio,e.bigMinRatio,e.bigMaxRatio,e.animate))}else m.length>0&&0===v.length?g(m,R,h,0,0,e.bigFixedRatio,e.bigMinRatio,e.bigMaxRatio,e.animate):g(v,R-u,h-b,u,b,e.fixedRatio,e.minRatio,e.maxRatio,e.animate)}};exports.initLayoutContainer=function(t,e){return e=i.defaults(e||{},{maxRatio:1.5,minRatio:9/16,fixedRatio:!1,animate:!1,bigClass:"OT_big",bigPercentage:.8,bigFixedRatio:!1,bigMaxRatio:1.5,bigMinRatio:9/16,bigFirst:!0}),t="string"==typeof t?i(t):t,OT.onload?OT.onLoad(function(){l(t,e)}):console.warn("OT.onLoad is not defined!"),{layout:l.bind(null,t,e)}},OT.initLayoutContainer=exports.initLayoutContainer}(window.hasOwnProperty("jQuery")?jQuery:void 0);